@model PagedList.IPagedList<Domain.ProductQuestion>
@using PagedList.Mvc;
@using ahmadi.Infrastructure.Helper
@using CoreLib.Infrastructure;
@using CoreLib.Infrastructure.DateTime
<title>مدیریت پرسش و پاسخ محصولات</title>

@{

    var HelpModule = ViewBag.HelpModule as Domain.HelpModule;
    int i = 0;
}
@section Header{

    <link href="~/Areas/Admin/Content/Stylesheets/View/ProductPrice.css" rel="stylesheet" />
    @*View*@
    <link href="~/Areas/Admin/Content/Stylesheets/View/Category.css" rel="stylesheet" />
    @*Persian Calender*@
    <link href="~/Areas/Admin/Content/Stylesheets/Component/calendar.css" rel="stylesheet" />
    <style>
        .File-Container {
            display: none
        }

        .Upload-container .user-profile .fa-camera {
            color: #fff
        }

        .sort {
            padding: 15px 9px;
        }

        .sort-items span {
            padding: 0 0 0 10px
        }

        .prq-item {
            border-top: 1px solid #eaeaea;
            padding: 10px 0
        }

        .sort-item {
            color: #fff;
            text-align: center;
            display: inline-block;
            padding: 5px 10px !important;
            margin: 0 10px;
        }

            .sort-item.selected a {
                color: #fff
            }

            .sort-item.selected {
                background-color: #ea7526;
            }

        .pr-title span, .text-name span {
            font-size: 0.8em;
            margin-left: 80px;
        }

        .text-message {
            font-size: 1.2em;
            font-weight: bold;
        }

        .answer {
            border: 1px solid #eaeaea;
            box-shadow: 2px 2px 0px #ccc;
            margin: 15px 0;
        }

            .answer .col-md-10 {
                background: lightcyan;
                padding: 15px 25px;
            }

        .your-answer {
            margin: 15px 10px;
            display: block;
            color: #888;
        }

        .text-title {
            font-size: 1em
        }

        .btn-answer {
            display: block;
            margin-top: 30px;
            cursor: pointer;
        }

        .replay {
            background-color: #f2eeee;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px 30px 25px 30px;
            display: none
        }

            .replay h3 {
                font-size: 1.3em;
                margin: 10px 0 10px 0
            }

            .replay p {
                font-size: 0.95em;
                margin: 10px 0 10px 0
            }

            .replay textarea {
                margin: 25px 0
            }

            .replay .btn-replay-container {
                margin: 35px 0 0 0
            }
    </style>
}

<div class="x_panel">
    <div class="x_content">
        <h3 class="box-title">
            پرسش و پاسخ محصولات
            <span style="cursor:pointer" class="glyphicon glyphicon-question-sign" data-html="true" data-toggle="tooltip" data-placement="right" title="@(HelpModule!=null?Html.Raw(HelpModule.Data).ToHtmlString():"راهنمایی وجود ندارد")"></span>

        </h3>
        <br /><br />


        <div class="x_panel">
            <div class="x_title">
                <h2><span class="glyphicon glyphicon-question-sign" data-html="true" data-toggle="tooltip" data-placement="left" title="@(HelpModule.HelpModuleSections.Where(x=>x.Name=="جست و جو").Any()?HelpModule.HelpModuleSections.Where(x=>x.Name=="جست و جو").First().Abstract:"")"></span> جستجو / فیلتر</h2>
                <ul class="nav navbar-left panel_toolbox">
                    <li>
                        <a class="collapse-link"><i class="fa fa-chevron-down"></i></a>
                    </li>

                    <li>
                        <a class="close-link"><i class="fa fa-close"></i></a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>

            <div class="x_content">
                <div id="SearchPage">
                    <div>
                        @using (Html.BeginForm("Index", "ProductQuestions", FormMethod.Get))
                        {
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                                <p>نام کاربر(نام و نام خانوادگی را با یک فاصله از هم جدا نمایید) :</p>
                                @Html.TextBox("UserString", ViewBag.UserFilter as string, htmlAttributes: new { style = "width:90%;display: inline-block", @class = "form-control" })
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                                <p>نام محصول :</p>
                                @Html.TextBox("ProductString", ViewBag.ProductFilter as string, htmlAttributes: new { style = "width:90%;display: inline-block", @class = "form-control" })
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                                <p>تاریخ ثبت پرسش از : </p>
                                <img src="~/Areas/Admin/Content/images/calender.gif" onclick="displayDatePicker('StartDateString');" alt="" />
                                @Html.TextBox("StartDateString", ViewBag.StartDateFilter as string, htmlAttributes: new { style = "width:85%;display: inline-block", @class = "form-control" })
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                                <p>تا :</p>
                                <img src="~/Areas/Admin/Content/images/calender.gif" onclick="displayDatePicker('EndDateString');" alt="" />
                                @Html.TextBox("EndDateString", ViewBag.EndDateFilter as string, htmlAttributes: new { style = "width:85%;display: inline-block", @class = "form-control" })
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                                <p>وضعیت : </p>
                                @Html.DropDownList("ActiveString", ViewBag.ActiveSelectListItem as IEnumerable<SelectListItem>, "--انتخاب نمایید--", htmlAttributes: new { style = "width:90%;display: inline-block", @class = "form-control" })
                            </div>

                            <div class="clearfix"></div><br />
                            <input type="submit" value="جست و جو" class="btn btn-success" />
                            @Html.ActionLink("نمایش همه", "Index", null, htmlAttributes: new { @class = "btn btn-success" })
                        }
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>

        @Html.PagedListPager(Model, page => Url.Action("Index", new { page, sortOrder = ViewBag.CurrentSort, UserFilter = ViewBag.UserFilter, ProductFilter = ViewBag.ProductFilter, StartDateFilter = ViewBag.StartDateFilter, EndDateFilter = ViewBag.EndDateFilter }))

        <div class="table-responsive">
            <div class="sort">
                <span class="sort-items">
                    <span class="fa fa-sort"></span>
                    <span class="sort-item-text">مرتب سازی بر اساس:</span>
                    <span class="@(ViewBag.CurrentSort=="Date_desc" || ViewBag.CurrentSort=="Date"?"sort-item selected":"sort-item")"><a href="@Url.Action("Index",new { sortOrder = ViewBag.CurrentSort != "Date_desc" ? "Date_desc" : "Date",UserFilter = ViewBag.UserFilter, ProductFilter = ViewBag.ProductFilter, StartDateFilter = ViewBag.StartDateFilter, EndDateFilter = ViewBag.EndDateFilter  })">تاریخ پرسش</a></span>
                    <span class="@(ViewBag.CurrentSort=="count_desc" || ViewBag.CurrentSort=="count"?"sort-item selected":"sort-item")"><a href="@Url.Action("Index",new { sortOrder = ViewBag.CurrentSort != "count_desc" ? "count_desc" : "count",UserFilter = ViewBag.UserFilter, ProductFilter = ViewBag.ProductFilter, StartDateFilter = ViewBag.StartDateFilter, EndDateFilter = ViewBag.EndDateFilter  })">بیشترین پاسخ</a></span>
                </span>
            </div>
            <div class="prq-items">
                <div class="File-Container">
                    <ul class="nav navbar-nav navbar-right Upload-container">
                        <li>
                            <a href="javascript:;" class="btn-success user-profile dropdown-toggle" data-toggle="dropdown">
                                <span class="fa fa-camera"></span>
                                <span class="fa fa-plus"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-usermenu pull-right">
                                <li role="presentation" class="dropdown-header">آپلود</li>
                                <li class="fileinput-button  fileinput-button">

                                    <span class="fa fa-upload"></span> <a class="openFileFromComputer" href="#"> از کامپیوتر </a>
                                    <form id="FormMultipleUpload2" enctype="multipart/form-data" method="post">
                                        <input type="file" name="UploadedFiles2" id="UploadedFiles2" multiple />
                                    </form>
                                    <div class="progress CustomProgress hide">
                                        <div id="FileProgress2" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                            <span></span>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="fa fa-link"></span> @Ajax.ActionLink("از فایل ها", "OpenAttachement", "FileManager", null, new AjaxOptions { HttpMethod = "GET", UpdateTargetId = "createView", OnBegin = "$('.loading').show();", OnSuccess = "$('.AttachementContainer').removeClass('hide');$('.loading').hide();createMode('AttachementContainer2',2)", InsertionMode = InsertionMode.Replace }, htmlAttributes: new { @class = "OpenFileManager AttachementContainer2" })
                                </li>
                            </ul>
                        </li>
                    </ul>

                    <div id="AttachementContainer2" class="AttachementContainer AttachementContainer2 hide">
                        <img src="~/Content/Default/images/default-thumbnail2.jpg" class="img-responsive" width="84" height="78" />
                        <input type="text" class="form-control text Ltr" readonly />

                        <input type="button" id="Addjanebi" value="افزودن به لیست" class="btn btn-primary" style="display:block" />
                    </div>

                    <ul id="janebi-images">
                    </ul>

                </div>
                <div id="createView"></div>
                @foreach (var item in Model.Where(x => !x.ParrentId.HasValue))
                {
                    <div class="prq-item">
                        <div class="col-md-2">
                            <a href="@Url.Action("Index","Product",new {Area = "", id=item.ProductId,name=CommonFunctions.NormalizeAddress(item.Product.Title) })"> @Html.Displayattachment(item.Product.ProductImages.First(x => x.IsMain).Image.FileName, item.Product.Title, "SM", htmlAttributes: new { @class = "img-responsive img-thumbnail", style = "display:inline-block;max-height:100px" })</a>
                        </div>
                        <div class="col-md-8">
                            <h2 class="pr-title">
                                <span>@item.Product.Title</span>
                                <span> کد فروش : @item.Product.ProductPrices.Where(x => x.IsDefault).First().code</span>
                            </h2>
                            <p class="text-message">@item.Message</p>
                            <p class="text-name">
                                <span>@item.User.FirstName @item.User.LastName </span>
                                <span>@CoreLib.Infrastructure.DateTime.DateTimeConverter.ChangeMiladiToLongShamsi(item.InsertDate) @item.InsertDate.ToShortTimeString()</span>
                            </p>
                        </div>
                        <div class="col-md-2">
                            <span class="btn-answer">
                                <span class="fa fa-reply-all"></span> <span>ثبت پاسخ</span>
                            </span>
                        </div>
                        <div class="clearfix"></div>

                        <div class="replay">
                            <h3>پاسخ شما به سوال</h3>
                            <p>پاسخ خود را بنویسید</p>
                            <textarea class="replay-message form-control" placeholder="جواب شما..." rows="4"></textarea>
                            <h3>افزودن عکس</h3>
                            <p>تصاویر خود را با توجه به <a href=""> پسوندهای مجاز </a>آپلود نمایید.</p>

                            <div class="file-add">

                            </div>
                            <div class="btn-replay-container">
                                <span class="btn btn-success btn-replay" data-id="@item.Id">ثبت پاسخ</span>
                                <span class="btn btn-default btn-close">انصراف</span>
                            </div>
                        </div>

                        @foreach (var item2 in item.ChildComment)
                        {
                            <div class="answer">
                                <div class="col-md-2">
                                    <span class="your-answer">پاسخ شما</span>
                                </div>

                                <div class="col-md-10">
                                    <h2 class="text-title">@item2.Message</h2>
                                    <p class="text-name">
                                        <span>@item2.User.FirstName @item2.User.LastName </span>
                                        <span>@CoreLib.Infrastructure.DateTime.DateTimeConverter.ChangeMiladiToLongShamsi(item2.InsertDate) @item2.InsertDate.ToShortTimeString()</span>
                                    </p>

                                </div>
                                <div class="clearfix"></div>
                            </div>
                        }

                    </div>
                    i++;
                }
            </div>
            <p>
                <strong style="color: #900">
                    صفحه  @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) از @Model.PageCount از میانِ @Model.TotalItemCount پرسش.
                </strong>
            </p>
            @Html.PagedListPager(Model, page => Url.Action("Index", new { page, sortOrder = ViewBag.CurrentSort, UserFilter = ViewBag.UserFilter, ProductFilter = ViewBag.ProductFilter, StartDateFilter = ViewBag.StartDateFilter, EndDateFilter = ViewBag.EndDateFilter }))
        </div>
    </div>
</div>
@section Scripts{
    <script src="~/Areas/Admin/Content/Scripts/View/Category.js"></script>
    @*Persian Calender*@
    <script src="~/Areas/Admin/Content/Scripts/Component/calendar.js"></script>
    <script src="~/Areas/Admin/Content/Scripts/Component/Pcalender.js"></script>
    <script src="~/Areas/Admin/Content/Scripts/View/CreateProductPrice.js?v=1.2.3"></script>


    @Scripts.Render("~/bundles/Admin/FileManager/Js")

    <script>
        $(document).ready(function () {
            $(".btn-answer").click(function () {
                $(this).parent().parent().find(".replay").fadeToggle();
                //$(this).parent().parent().find(".replay").toggleClass("open");
                //if ($(this).parent().parent().find(".replay").hasClass("open"))
                $(this).parent().parent().find(".replay .file-add").prepend($(".File-Container"));
                $(".File-Container").css("display", "flex");
            });
            $(".btn-close").click(function () {
                $(this).parent().parent().fadeOut();
            });

            $(".btn-replay").click(function (e) {
                e.preventDefault();

                var files = [];
                $("#janebi-images input[type='hidden']").each(function () {
                    files.push($(this).val());
                });

                var $this = $(this);
                if ($this.parent().parent().find(".replay-message").val()) {
                    $(".loading").show();
                    var $this = $(this);
                    $.ajax({
                        crossDomain: true,
                        type: "POST",
                        url: '/Admin/ProductQuestions/replay',
                        data: JSON.stringify({ Id: $this.attr("data-id"), ReplayMessage: $this.parent().parent().find(".replay-message").val(), janebi: files }),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (response) {
                            if (response.statusCode == 200) {
                                $("#janebi-images").html("");
                                $this.parent().parent().fadeOut();
                                $this.parent().parent().find(".replay-message").val("");
                                swal({ title: "", text: response.message, type: "success", showCancelButton: false, confirmButtonClass: 'btn-error', confirmButtonText: 'بستن' });
                            }
                            else {
                                swal({ title: "", text: response.message, type: "error", showCancelButton: false, confirmButtonClass: 'btn-error', confirmButtonText: 'بستن' });

                            }
                            $(".loading").hide();
                        }
                    });
                }
                else {
                    swal({ title: "", text: "پاسخ خود را بنویسید !", type: "error", showCancelButton: false, confirmButtonClass: 'btn-error', confirmButtonText: 'بستن' });

                }
            });
        });
    </script>
}
